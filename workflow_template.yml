name: AI Repository Monitor Sync

on:
  schedule:
    # æ¯å¤© UTC 22:00 è¿è¡Œ (åŒ—äº¬æ—¶é—´ 6:00)
    - cron: '0 22 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      update_activity:
        description: 'æ˜¯å¦æ›´æ–°æ´»è·ƒåº¦æ•°æ®'
        required: false
        default: 'true'
        type: boolean

jobs:
  sync-repositories:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'
          
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: éªŒè¯é…ç½®
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
        run: |
          echo "ğŸ”§ éªŒè¯APIé…ç½®..."
          python3 test_config.py
          
      - name: åŒæ­¥AIé¡¹ç›®æ•°æ®
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
        run: |
          echo "ğŸš€ å¼€å§‹åŒæ­¥AIé¡¹ç›®æ•°æ®..."
          python3 sync_d1.py
          
      - name: æ›´æ–°æ´»è·ƒåº¦æ•°æ®
        if: ${{ github.event.inputs.update_activity == 'true' || github.event_name == 'schedule' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
        run: |
          echo "ğŸ“Š æ›´æ–°é¡¹ç›®æ´»è·ƒåº¦æ•°æ®..."
          python3 -c "
          from update_activity_data import batch_update_activity_data
          batch_update_activity_data(limit=20)
          "
          
      - name: ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
        run: |
          echo "ğŸ“ˆ ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š..."
          python3 -c "
          import os
          from cloudflare import Cloudflare
          from dotenv import load_dotenv
          
          load_dotenv()
          client = Cloudflare(api_token=os.environ.get('CLOUDFLARE_API_TOKEN'))
          
          # è·å–ç»Ÿè®¡æ•°æ®
          response = client.d1.database.query(
              database_id=os.environ.get('D1_DATABASE_ID'),
              account_id=os.environ.get('CLOUDFLARE_ACCOUNT_ID'),
              sql='SELECT COUNT(*) as total, COUNT(CASE WHEN activity_score > 0 THEN 1 END) as active FROM repos'
          )
          
          if response.success and response.result:
              stats = response.result[0].results[0]
              print(f'ğŸ“Š æ€»é¡¹ç›®æ•°: {stats[\"total\"]}')
              print(f'ğŸ”¥ æ´»è·ƒé¡¹ç›®: {stats[\"active\"]}')
              print(f'âœ… åŒæ­¥å®Œæˆ!')
          "
          
      - name: æ£€æŸ¥APIä½¿ç”¨æƒ…å†µ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” æ£€æŸ¥GitHub APIä½¿ç”¨æƒ…å†µ..."
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               https://api.github.com/rate_limit | \
          python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          core = data['rate']
          print(f'ğŸ“Š APIä½¿ç”¨æƒ…å†µ: {core[\"used\"]}/{core[\"limit\"]} (å‰©ä½™: {core[\"remaining\"]})')
          reset_time = core['reset']
          from datetime import datetime
          reset_dt = datetime.fromtimestamp(reset_time)
          print(f'ğŸ”„ é‡ç½®æ—¶é—´: {reset_dt}')
          "

